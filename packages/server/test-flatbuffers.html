<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlatBuffers WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ FlatBuffers WebSocket Test</h1>
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div class="controls">
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            <button id="sendDataBtn" onclick="sendDataMessage()" disabled>Send Data Message</button>
            <button id="sendHeartbeatBtn" onclick="sendHeartbeatMessage()" disabled>Send Heartbeat</button>
            <button id="clearLogBtn" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        // Import FlatBuffers
        import * as flatbuffers from 'https://unpkg.com/flatbuffers@2.0.0/flatbuffers.mjs';
        
        // MessageType enum values
        const MessageType = {
            Connect: 0,
            Disconnect: 1,
            Data: 2,
            Heartbeat: 3,
            Reconnect: 4,
            Error: 5
        };

        // MessageData union values
        const MessageData = {
            NONE: 0,
            ConnectMessage: 1,
            DisconnectMessage: 2,
            DataMessage: 3,
            HeartbeatMessage: 4,
            ReconnectMessage: 5,
            ErrorMessage: 6
        };

        // Simple FlatBuffers message creation functions
        function createConnectMessage(builder, sessionId, clientVersion) {
            const sessionIdOffset = builder.createString(sessionId);
            const clientVersionOffset = builder.createString(clientVersion);
            
            // Create ConnectMessage table
            const connectMessageStart = flatbuffers.startTable(builder, 2);
            flatbuffers.addFieldOffset(builder, 0, sessionIdOffset, 0); // session_id
            flatbuffers.addFieldOffset(builder, 1, clientVersionOffset, 0); // client_version
            const connectMessage = flatbuffers.endTable(builder, connectMessageStart);
            
            return connectMessage;
        }

        function createDataMessage(builder, payload, messageId, timestamp) {
            const payloadVector = flatbuffers.createByteVector(builder, payload);
            
            // Create DataMessage table
            const dataMessageStart = flatbuffers.startTable(builder, 3);
            flatbuffers.addFieldOffset(builder, 0, payloadVector, 0); // payload
            flatbuffers.addFieldInt64(builder, 1, messageId, BigInt(0)); // message_id
            flatbuffers.addFieldInt64(builder, 2, timestamp, BigInt(0)); // timestamp
            const dataMessage = flatbuffers.endTable(builder, dataMessageStart);
            
            return dataMessage;
        }

        function createHeartbeatMessage(builder, timestamp) {
            // Create HeartbeatMessage table
            const heartbeatMessageStart = flatbuffers.startTable(builder, 1);
            flatbuffers.addFieldInt64(builder, 0, timestamp, BigInt(0)); // timestamp
            const heartbeatMessage = flatbuffers.endTable(builder, heartbeatMessageStart);
            
            return heartbeatMessage;
        }

        function createMessage(builder, type, dataType, dataOffset) {
            // Create Message table
            const messageStart = flatbuffers.startTable(builder, 3);
            flatbuffers.addFieldInt8(builder, 0, type, MessageType.Connect); // type
            flatbuffers.addFieldInt8(builder, 1, dataType, MessageData.NONE); // data_type
            flatbuffers.addFieldOffset(builder, 2, dataOffset, 0); // data
            const message = flatbuffers.endTable(builder, messageStart);
            
            return message;
        }

        // Global variables
        let ws = null;
        let messageIdCounter = 0;

        // Logging function
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Update status
        function updateStatus(connected) {
            const statusElement = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendDataBtn = document.getElementById('sendDataBtn');
            const sendHeartbeatBtn = document.getElementById('sendHeartbeatBtn');
            
            if (connected) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendDataBtn.disabled = false;
                sendHeartbeatBtn.disabled = false;
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendDataBtn.disabled = true;
                sendHeartbeatBtn.disabled = true;
            }
        }

        // Connect to WebSocket
        window.connect = function() {
            const wsUrl = 'ws://localhost:8091';
            log('ğŸ”— Connecting to ' + wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                log('âœ… WebSocket connected');
                updateStatus(true);
                sendConnectMessage();
            };
            
            ws.onmessage = function(event) {
                handleMessage(event.data);
            };
            
            ws.onclose = function() {
                log('ğŸ”Œ WebSocket connection closed');
                updateStatus(false);
            };
            
            ws.onerror = function(error) {
                log('âŒ WebSocket error: ' + error);
            };
        };

        // Disconnect from WebSocket
        window.disconnect = function() {
            if (ws) {
                ws.close();
                ws = null;
            }
        };

        // Send connect message
        function sendConnectMessage() {
            log('ğŸ“¤ Creating and sending FlatBuffers Connect message...');
            
            const builder = new flatbuffers.Builder(1024);
            const sessionId = 'browser_session_' + Date.now();
            const clientVersion = '1.0.0-browser';
            
            const connectMessage = createConnectMessage(builder, sessionId, clientVersion);
            const message = createMessage(builder, MessageType.Connect, MessageData.ConnectMessage, connectMessage);
            
            builder.finish(message);
            const flatbuffersData = builder.asUint8Array();
            
            log('ğŸ“¤ Sending ' + flatbuffersData.length + ' bytes of FlatBuffers data');
            log('ğŸ“¤ First 20 bytes: [' + Array.from(flatbuffersData.slice(0, 20)).join(', ') + ']');
            
            ws.send(flatbuffersData);
        }

        // Send data message
        window.sendDataMessage = function() {
            const testData = 'Hello from FlatBuffers in Browser! ' + Date.now();
            log('ğŸ“¤ Creating FlatBuffers Data message: ' + testData);
            
            const builder = new flatbuffers.Builder(1024);
            const payload = new TextEncoder().encode(testData);
            const messageId = BigInt(++messageIdCounter);
            const timestamp = BigInt(Date.now());
            
            const dataMessage = createDataMessage(builder, payload, messageId, timestamp);
            const message = createMessage(builder, MessageType.Data, MessageData.DataMessage, dataMessage);
            
            builder.finish(message);
            const flatbuffersData = builder.asUint8Array();
            
            log('ğŸ“¤ Sending ' + flatbuffersData.length + ' bytes of FlatBuffers data');
            ws.send(flatbuffersData);
        };

        // Send heartbeat message
        window.sendHeartbeatMessage = function() {
            log('ğŸ“¤ Creating FlatBuffers Heartbeat message...');
            
            const builder = new flatbuffers.Builder(1024);
            const timestamp = BigInt(Date.now());
            
            const heartbeatMessage = createHeartbeatMessage(builder, timestamp);
            const message = createMessage(builder, MessageType.Heartbeat, MessageData.HeartbeatMessage, heartbeatMessage);
            
            builder.finish(message);
            const flatbuffersData = builder.asUint8Array();
            
            log('ğŸ“¤ Sending ' + flatbuffersData.length + ' bytes of FlatBuffers data');
            ws.send(flatbuffersData);
        };

        // Handle incoming messages
        function handleMessage(data) {
            log('ğŸ“¥ Received message from server');
            log('ğŸ“¥ Data type: ' + data.constructor.name);
            log('ğŸ“¥ Data length: ' + data.length);
            
            if (data instanceof ArrayBuffer) {
                const uint8Array = new Uint8Array(data);
                log('ğŸ“¥ First 20 bytes: [' + Array.from(uint8Array.slice(0, 20)).join(', ') + ']');
                
                try {
                    // Try to parse as FlatBuffers
                    const buf = new flatbuffers.ByteBuffer(uint8Array);
                    const messageOffset = buf.readInt32(buf.position()) + buf.position();
                    buf.setPosition(messageOffset);
                    
                    // Read message type (first field)
                    const messageType = buf.readInt8(messageOffset + 4);
                    log('ğŸ“¥ Parsed FlatBuffers message type: ' + messageType);
                    
                    // Try to decode as text if it looks like text
                    const text = new TextDecoder().decode(uint8Array);
                    if (text.includes('response') || text.includes('heartbeat')) {
                        log('ğŸ“¥ Text message: ' + text);
                    }
                    
                } catch (error) {
                    log('ğŸ“¥ Failed to parse as FlatBuffers, trying as text...');
                    try {
                        const text = new TextDecoder().decode(uint8Array);
                        log('ğŸ“¥ Text message: ' + text);
                    } catch (textError) {
                        log('ğŸ“¥ Failed to parse as text: ' + textError);
                    }
                }
            } else {
                log('ğŸ“¥ Non-ArrayBuffer data: ' + data);
            }
        }

        // Clear log
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // Initialize
        log('ğŸš€ FlatBuffers WebSocket Test initialized');
        log('Click "Connect" to start the test');
    </script>
</body>
</html>
